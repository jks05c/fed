name: GitHub Actions Demo and Run Azure Login with OpenID Connect
on: [push]
permissions:
  id-token: write
jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      - run: echo "ðŸŽ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ðŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "ðŸ”Ž The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v2
      - run: echo "ðŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "ðŸ–¥ï¸ The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
      - run: echo "ðŸ This job's status is ${{ job.status }}."
  Windows-latest:
    runs-on: windows-latest
    steps:
      - name: Install CLI-beta
        run:
          cd ../..
          $CWD = Convert-Path .
          echo $CWD
          python --version
          python -m venv oidc-venc
          . ./oidc-venv/Scripts/Activate.ps1
          python -m pip install -q --upgrade pip
          echo "started installing cli beta"
          pip install -q --extra-index-url https://azcliprod.blob.core.windows.net/beta/simple/ azure-cli
          echo "installed cli beta" 
          echo "$CWD\oidc-venv\Scripts" >> $env:GITHUB_PATH
      - name: Installing Az.accounts for powershell
        shell: pwsh
        run: |
          Install Module -Name Az.accounts -Force -AllowClobber -Repository PSGallery

      - name: OIDC Login to Azure Public Cloud with AzPowershell (enableAzPSSession true)
        uses: azure/login@v1.4.0
        with:
          client-id: ${{ secrets.AZURE_CLIENTID }}
          tenant-id: ${{ secrets.TENANTID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTIONID }}
          enable-AzPSSession: true
